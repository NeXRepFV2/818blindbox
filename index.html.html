<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NEXREP å…¨æ°‘ä»£è¨€è®¡åˆ’ Â· ç›²ç›’æŠ½å¥–ï¼ˆç®€åŒ–ä¸ŠæŠ¥ç‰ˆï¼‰</title>
<meta name="description" content="NEXREP ç›²ç›’æŠ½å¥– Â· 500æ¬¡åˆ†æ®µæ‰è½ Â· ä¸€/äºŒ/ä¸‰ç­‰å¥–åˆ†æ®µé…é¢ Â· å››ç­‰å¥–å…œåº• Â· ä»…ä¸ŠæŠ¥ IDå·/å¥–é¡¹/æŠ½å¥–æ—¶é—´(GMT+8)" />
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#f59e0b; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial;background:var(--bg);color:var(--text)}
  header{padding:14px 18px;border-bottom:1px solid #1f2937;display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit}
  input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  label{font-size:12px;color:#cbd5e1}
  button{background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:hover{border-color:#4b5563}
  button.primary{background:#1e293b;border-color:#475569}
  .stat{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .pill{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
  .big{font-size:26px;font-weight:700}
  .log{height:320px;overflow:auto;border-radius:10px;background:#0b1220;border:1px solid #1f2937;padding:8px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{padding:8px;text-align:center;font-size:13px}
  tr{background:#0b1220}
  th{color:#cbd5e1}
  canvas{width:100%;height:260px;background:#0b1220;border:1px solid #1f2937;border-radius:10px}
  .logoWrap{display:flex;align-items:center;gap:12px}
  .logoBox{position:relative;display:inline-block;filter: drop-shadow(0 0 8px rgba(245,158,11,.25));}
  .logo{width:92px;height:92px;border-radius:18px;object-fit:cover;transform-origin:center;animation:float 3.5s ease-in-out infinite}
  .ring{position:absolute;inset:-8px;border-radius:24px;box-shadow:0 0 0 0 rgba(245,158,11,.35);animation:ping 2.2s ease-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
  @keyframes ping{0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}70%{box-shadow:0 0 0 14px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}
  .shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97) both}
  @keyframes shake{
    10%,90%{transform:translate3d(-1px,0,0) rotate(-1.5deg)}
    20%,80%{transform:translate3d(2px,0,0) rotate(1.2deg)}
    30%,50%,70%{transform:translate3d(-4px,0,0) rotate(-1.2deg)}
    40%,60%{transform:translate3d(4px,0,0) rotate(1.2deg)}
  }
  .box{margin: 10px auto; width: 220px; height: 220px; border-radius: 16px; background:#0b1220 center/cover no-repeat; border:1px solid #1f2937;}
</style>
</head>
<body>
<header>
  <div class="logoWrap">
    <div class="logoBox" id="logoBox" title="å¯èˆªç››å…¸ / Mystery Box">
      <!-- å¦‚éœ€æ›´æ¢ä¸ºä½ ä»“åº“ä¸­çš„ logoï¼Œè¯·æ›¿æ¢ä¸‹åˆ— src åœ°å€ -->
      <img class="logo" id="logo" src="af765433-0392-4dbf-a263-7fc06c80052a.png" alt="å¯èˆªç››å…¸ Logo"/>
      <div class="ring"></div>
    </div>
    <div>
      <h1>ğŸ NEXREP ç›²ç›’æŠ½å¥– <span class="muted">ï¼ˆ500 æ¬¡ Â· åˆ†æ®µæ‰è½ Â· å››ç­‰å¥–å…œåº•ï¼‰</span></h1>
      <div class="muted">å¼€åœº & ä¸­åœºä¼šæœ‰ RM1000 çˆ†ç‚¹ï¼›æœªä¸­é«˜æ¡£å¥–åˆ™å‘ RM100ï¼ˆå››ç­‰å¥–ï¼‰ã€‚</div>
    </div>
  </div>
  <div class="row">
    <button id="btnDraw" class="primary">æŠ½ä¸€æ¬¡</button>
    <button id="btnSim100">æ¨¡æ‹Ÿ100æ¬¡</button>
    <button id="btnFinish">æŠ½åˆ°500æ¬¡</button>
    <button id="btnReset">é‡ç½®ï¼ˆæ–°ç§å­ï¼‰</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row" style="gap:10px">
      <div style="flex:1;min-width:220px">
        <label>IDå· (ZMYXXXXXXXX)</label>
        <input type="text" id="userID" placeholder="ZMY12345678"/>
      </div>
      <div style="flex:1;min-width:160px">
        <label>æœ¬æ¬¡æŠ½å¥–æ¬¡æ•°</label>
        <input type="number" id="chances" min="1" value="1"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>ä¸Šä¼ ç›²ç›’å›¾ç‰‡</label>
        <input type="file" id="boxImageInput" accept="image/*"/>
      </div>
      <div>
        <label>ä¸Šä¼ èƒŒæ™¯å›¾</label>
        <input type="file" id="bgImageInput" accept="image/*"/>
      </div>
      <button id="btnStart" class="primary">å¼€å§‹æŠ½å¥–</button>
      <button id="btnExport">å¯¼å‡ºæŠ½å¥–è®°å½• CSV</button>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div>
        <div class="muted">å½“å‰è¿›åº¦</div>
        <div id="progress" class="big">ç¬¬ 0 / 500 æ¬¡</div>
      </div>
      <div>
        <div class="muted">æœ¬æ¬¡ç»“æœ</div>
        <div id="result" class="big">â€”</div>
      </div>
    </div>

    <div class="stat">
      <div class="pill">ä¸€ç­‰å¥– RM1000ï¼š<b id="cG1">0</b> / 4</div>
      <div class="pill">äºŒç­‰å¥– RM300ï¼š<b id="cG2">0</b> / 23</div>
      <div class="pill">ä¸‰ç­‰å¥– RM200ï¼š<b id="cG3">0</b> / 48</div>
      <div class="pill">å››ç­‰å¥– RM100ï¼š<b id="cG4">0</b> / 425</div>
    </div>

    <div class="box" id="box"></div>

    <div class="muted">çƒ­ç‚¹çª—å£ï¼šS1[1â€“20]ã€S3[190â€“230]ã€S4[360â€“420]ã€S5[460â€“500]</div>

    <h3 style="margin-top:14px">æ®µé…é¢</h3>
    <table>
      <thead><tr><th>æ®µåˆ«</th><th>åŒºé—´</th><th>æ¬¡æ•°</th><th>ä¸€ç­‰å¥–</th><th>äºŒç­‰å¥–</th><th>ä¸‰ç­‰å¥–</th><th>å››ç­‰å¥–(å…œåº•)</th></tr></thead>
      <tbody id="segTable"></tbody>
    </table>
  </div>

  <div class="card">
    <canvas id="chart"></canvas>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
// ===== ä½ çš„ Apps Script åœ°å€ï¼ˆä»…ä¸ŠæŠ¥ IDå·ã€å¥–é¡¹ã€æŠ½å¥–æ—¶é—´ï¼‰ =====
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzW68GNeAgwX_5Bw0kRqcG2EBX_uT6G-FPvmLEQwF9ufCuQSVWUAs4R3x6E9cZ-26GF/exec";

// ===== å…¨å±€å‚æ•° =====
const TOTAL_DRAWS = 500;
const CONFIG = {
  segments: [
    {name:"S1", start:1, end:50},
    {name:"S2", start:51, end:150},
    {name:"S3", start:151, end:300},
    {name:"S4", start:301, end:450},
    {name:"S5", start:451, end:500},
  ],
  quotas: { // ä¸€äºŒä¸‰ç­‰æŒ‰åˆ†æ®µé…é¢ï¼›å››ç­‰è‡ªåŠ¨è¡¥è¶³
    G1:[1,0,1,1,1],   // RM1000
    G2:[4,5,6,6,2],   // RM300
    G3:[10,10,12,12,4]// RM200
  },
  hotWindows: { // ç”¨äºG1çƒ­ç‚¹çª—å£ï¼ˆå¼€åœº/ä¸­åœº/åæ®µ/æ”¶å®˜ï¼‰
    0:[1,20],  2:[190,230], 3:[360,420], 4:[460,500]
  },
  values: {G1:1000, G2:300, G3:200, G4:100},
  labels: {G1:"RM1000 ä¸€ç­‰å¥–", G2:"RM300 äºŒç­‰å¥–", G3:"RM200 ä¸‰ç­‰å¥–", G4:"RM100 å››ç­‰å¥–"}
};

// ===== å·¥å…·å‡½æ•° =====
function seededRandom(seed){
  return function() {
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function sampleWithoutReplacement(arr, k, rand=Math.random){
  const a = arr.slice(), res = [];
  for(let i=0;i<k && a.length>0;i++){
    const j = Math.floor(rand()*a.length);
    res.push(a[j]); a.splice(j,1);
  }
  return res;
}
function buildSchedule(seed){
  const rand = seededRandom(seed);
  const assignments = {}, occupied = new Set();
  const cfg = CONFIG;
  // G1 with hot windows
  cfg.segments.forEach((seg, idx)=>{
    const q = cfg.quotas.G1[idx]||0; if(q<=0) return;
    let start=seg.start, end=seg.end, candidates=[];
    if(cfg.hotWindows[idx]){
      let [hs,he] = cfg.hotWindows[idx];
      hs=Math.max(hs,start); he=Math.min(he,end);
      for(let d=hs; d<=he; d++) candidates.push(d);
      if(candidates.length<q){ // fallback to whole segment
        candidates=[]; for(let d=start; d<=end; d++) candidates.push(d);
      }
    }else{ for(let d=start; d<=end; d++) candidates.push(d); }
    const picks = sampleWithoutReplacement(candidates, q, rand);
    for(const d of picks){ assignments[d]="G1"; occupied.add(d); }
  });
  // G2/G3
  for(const prize of ["G2","G3"]){
    cfg.segments.forEach((seg, idx)=>{
      const q = cfg.quotas[prize][idx]||0; if(q<=0) return;
      const candidates = [];
      for(let d=seg.start; d<=seg.end; d++){ if(!occupied.has(d)) candidates.push(d); }
      const picks = sampleWithoutReplacement(candidates, q, rand);
      // å…œåº•è¡¥è¶³
      let i=seg.start; while(picks.length<q && i<=seg.end){
        if(!occupied.has(i) && !picks.includes(i)) picks.push(i); i++;
      }
      for(const d of picks){ assignments[d]=prize; occupied.add(d); }
    });
  }
  // fill G4
  for(const seg of cfg.segments){ for(let d=seg.start; d<=seg.end; d++){ if(!assignments[d]) assignments[d]="G4"; } }
  return assignments;
}

// ===== çŠ¶æ€ =====
let state = { seed: Math.floor(Math.random()*1e9), schedule:{}, draw:0, counts:{G1:0,G2:0,G3:0,G4:0}, log:[], records:[] };

// ===== è§†å›¾å¼•ç”¨ =====
const el = {
  progress: document.getElementById("progress"),
  result: document.getElementById("result"),
  cG1: document.getElementById("cG1"),
  cG2: document.getElementById("cG2"),
  cG3: document.getElementById("cG3"),
  cG4: document.getElementById("cG4"),
  segTable: document.getElementById("segTable"),
  log: document.getElementById("log"),
  chart: document.getElementById("chart"),
  box: document.getElementById("box"),
  logoBox: document.getElementById("logoBox"),
  userID: document.getElementById("userID"),
  chances: document.getElementById("chances")
};

// ===== åˆå§‹åŒ–/é‡ç½® =====
function reset(newSeed){
  state.seed = newSeed ?? Math.floor(Math.random()*1e9);
  state.schedule = buildSchedule(state.seed);
  state.draw = 0; state.counts = {G1:0,G2:0,G3:0,G4:0}; state.log = []; state.records = [];
  initChart(); render(); buildSegTable();
}
function buildSegTable(){
  const g4 = [];
  CONFIG.segments.forEach((seg, idx)=>{
    const len=seg.end - seg.start + 1;
    const g1=CONFIG.quotas.G1[idx]||0, g2=CONFIG.quotas.G2[idx]||0, g3=CONFIG.quotas.G3[idx]||0;
    g4[idx]=len-(g1+g2+g3);
  });
  el.segTable.innerHTML = CONFIG.segments.map((seg,idx)=>{
    const len=seg.end - seg.start + 1;
    return `<tr><td>${seg.name}</td><td>${seg.start}â€“${seg.end}</td><td>${len}</td>
      <td>${CONFIG.quotas.G1[idx]||0}</td><td>${CONFIG.quotas.G2[idx]||0}</td><td>${CONFIG.quotas.G3[idx]||0}</td><td>${g4[idx]}</td></tr>`;
  }).join("");
}

// ===== æŠ½å¥–å¼•æ“ =====
function doDraw(){
  if(state.draw>=TOTAL_DRAWS) return;
  const userID = el.userID.value.trim();
  if(!userID){ alert("è¯·è¾“å…¥IDå·"); return; }

  state.draw++;
  const code = state.schedule[state.draw];
  state.counts[code]++;
  const value = CONFIG.values[code];
  const label = CONFIG.labels[code];
  const now = new Date();
  const time = new Date(now.getTime() + 8*60*60*1000).toISOString().replace('T',' ').split('.')[0] + " GMT+8";

  state.log.unshift(`ç¬¬ ${String(state.draw).padStart(3,"0")} æ¬¡ â†’ ${label}`);
  if(state.log.length>400) state.log.pop();
  state.records.push({ userID, prize:label, time });

  // Google è®°å½•ï¼ˆä»…ID/å¥–é¡¹/æ—¶é—´ï¼‰
  try {
    fetch(GOOGLE_SCRIPT_URL, {
      method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userID, prize:label, time })
    });
  } catch(e){ console.warn("Googleè®°å½•å¤±è´¥ï¼ˆæœ¬åœ°/è·¨åŸŸç¯å¢ƒå¸¸è§ï¼‰ï¼š", e); }

  // è§†è§‰åé¦ˆï¼šLogo æ‘‡åŠ¨
  el.logoBox.classList.remove("shake"); void el.logoBox.offsetWidth; el.logoBox.classList.add("shake");
  render(); plotPoint(state.draw, value);
}
function simulate(n){
  const count = parseInt(n,10)||0;
  for(let i=0;i<count;i++){ if(state.draw>=TOTAL_DRAWS) break; doDraw(); }
}

// ===== å¯¼å‡ºè®°å½• =====
function exportCSV(){
  let csv = "\uFEFFIDå·,å¥–é¡¹,æŠ½å¥–æ—¶é—´(GMT+8)\n";
  state.records.forEach(r=>{ csv += `${r.userID},${r.prize},${r.time}\n`; });
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "æŠ½å¥–è®°å½•.csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// ===== æ¸²æŸ“ =====
function render(){
  el.progress.textContent = `ç¬¬ ${state.draw} / ${TOTAL_DRAWS} æ¬¡`;
  el.result.textContent = state.log[0] ? state.log[0].split("â†’")[1].trim() : "â€”";
  el.cG1.textContent = state.counts.G1;
  el.cG2.textContent = state.counts.G2;
  el.cG3.textContent = state.counts.G3;
  el.cG4.textContent = state.counts.G4;
  el.log.innerHTML = state.log.map(l=>`<div>${l}</div>`).join("");
}

// ===== ç®€å•æ•£ç‚¹å›¾ =====
let ctx, chartW, chartH;
function initChart(){
  const canvas = el.chart;
  const dpr = window.devicePixelRatio || 1;
  chartW = canvas.clientWidth * dpr;
  chartH = canvas.clientHeight * dpr;
  canvas.width = chartW; canvas.height = chartH;
  ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,chartW,chartH);
  ctx.strokeStyle = "#2a3344"; ctx.lineWidth = 1;
  [100,200,300,1000].forEach(v=>{
    const y = mapY(v);
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(chartW,y); ctx.stroke();
    ctx.fillStyle="#64748b"; ctx.font = `${12*(window.devicePixelRatio||1)}px sans-serif`;
    ctx.fillText("RM"+v, 6, y-4);
  });
}
function mapX(n){ return (n/TOTAL_DRAWS)* (chartW-20) + 10; }
function mapY(v){ const vmin=100, vmax=1000; const t=(v-vmin)/(vmax-vmin); return chartH - (t*(chartH-20)+10); }
function plotPoint(n, value){
  if(!ctx) return;
  ctx.fillStyle = "#60a5fa";
  const x = mapX(n), y = mapY(value);
  ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
}

// ===== äº‹ä»¶ç»‘å®š & å›¾ç‰‡æ›¿æ¢ =====
document.getElementById("btnStart").onclick = ()=>{
  const n = parseInt(el.chances.value || "1", 10);
  for(let i=0;i<n;i++){ setTimeout(()=>doDraw(), i*300); }
};
document.getElementById("btnExport").onclick = exportCSV;
document.getElementById("btnDraw").onclick = ()=>doDraw();
document.getElementById("btnSim100").onclick = ()=>simulate(100);
document.getElementById("btnFinish").onclick = ()=>simulate(1000);
document.getElementById("btnReset").onclick = ()=>reset();

document.getElementById("boxImageInput").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => el.box.style.backgroundImage = `url(${evt.target.result})`;
  reader.readAsDataURL(file);
});
document.getElementById("bgImageInput").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => { document.body.style.background = `#000 url(${evt.target.result}) center/cover no-repeat fixed`; };
  reader.readAsDataURL(file);
});

// åˆå§‹
window.addEventListener("resize", ()=>{ initChart(); render(); });
reset();
</script>
</body>
</html>

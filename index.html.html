<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NEXREP 全民代言计划 · 盲盒抽奖（简化上报版）</title>
<meta name="description" content="NEXREP 盲盒抽奖 · 500次分段掉落 · 一/二/三等奖分段配额 · 四等奖兜底 · 仅上报 ID号/奖项/抽奖时间(GMT+8)" />
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#f59e0b; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial;background:var(--bg);color:var(--text)}
  header{padding:14px 18px;border-bottom:1px solid #1f2937;display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit}
  input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  label{font-size:12px;color:#cbd5e1}
  button{background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:hover{border-color:#4b5563}
  button.primary{background:#1e293b;border-color:#475569}
  .stat{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .pill{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
  .big{font-size:26px;font-weight:700}
  .log{height:320px;overflow:auto;border-radius:10px;background:#0b1220;border:1px solid #1f2937;padding:8px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{padding:8px;text-align:center;font-size:13px}
  tr{background:#0b1220}
  th{color:#cbd5e1}
  canvas{width:100%;height:260px;background:#0b1220;border:1px solid #1f2937;border-radius:10px}
  .logoWrap{display:flex;align-items:center;gap:12px}
  .logoBox{position:relative;display:inline-block;filter: drop-shadow(0 0 8px rgba(245,158,11,.25));}
  .logo{width:92px;height:92px;border-radius:18px;object-fit:cover;transform-origin:center;animation:float 3.5s ease-in-out infinite}
  .ring{position:absolute;inset:-8px;border-radius:24px;box-shadow:0 0 0 0 rgba(245,158,11,.35);animation:ping 2.2s ease-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
  @keyframes ping{0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}70%{box-shadow:0 0 0 14px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}
  .shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97) both}
  @keyframes shake{
    10%,90%{transform:translate3d(-1px,0,0) rotate(-1.5deg)}
    20%,80%{transform:translate3d(2px,0,0) rotate(1.2deg)}
    30%,50%,70%{transform:translate3d(-4px,0,0) rotate(-1.2deg)}
    40%,60%{transform:translate3d(4px,0,0) rotate(1.2deg)}
  }
  .box{margin: 10px auto; width: 220px; height: 220px; border-radius: 16px; background:#0b1220 center/cover no-repeat; border:1px solid #1f2937;}
</style>
</head>
<body>
<header>
  <div class="logoWrap">
    <div class="logoBox" id="logoBox" title="启航盛典 / Mystery Box">
      <!-- 如需更换为你仓库中的 logo，请替换下列 src 地址 -->
      <img class="logo" id="logo" src="af765433-0392-4dbf-a263-7fc06c80052a.png" alt="启航盛典 Logo"/>
      <div class="ring"></div>
    </div>
    <div>
      <h1>🎁 NEXREP 盲盒抽奖 <span class="muted">（500 次 · 分段掉落 · 四等奖兜底）</span></h1>
      <div class="muted">开场 & 中场会有 RM1000 爆点；未中高档奖则发 RM100（四等奖）。</div>
    </div>
  </div>
  <div class="row">
    <button id="btnDraw" class="primary">抽一次</button>
    <button id="btnSim100">模拟100次</button>
    <button id="btnFinish">抽到500次</button>
    <button id="btnReset">重置（新种子）</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row" style="gap:10px">
      <div style="flex:1;min-width:220px">
        <label>ID号 (ZMYXXXXXXXX)</label>
        <input type="text" id="userID" placeholder="ZMY12345678"/>
      </div>
      <div style="flex:1;min-width:160px">
        <label>本次抽奖次数</label>
        <input type="number" id="chances" min="1" value="1"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>上传盲盒图片</label>
        <input type="file" id="boxImageInput" accept="image/*"/>
      </div>
      <div>
        <label>上传背景图</label>
        <input type="file" id="bgImageInput" accept="image/*"/>
      </div>
      <button id="btnStart" class="primary">开始抽奖</button>
      <button id="btnExport">导出抽奖记录 CSV</button>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div>
        <div class="muted">当前进度</div>
        <div id="progress" class="big">第 0 / 500 次</div>
      </div>
      <div>
        <div class="muted">本次结果</div>
        <div id="result" class="big">—</div>
      </div>
    </div>

    <div class="stat">
      <div class="pill">一等奖 RM1000：<b id="cG1">0</b> / 4</div>
      <div class="pill">二等奖 RM300：<b id="cG2">0</b> / 23</div>
      <div class="pill">三等奖 RM200：<b id="cG3">0</b> / 48</div>
      <div class="pill">四等奖 RM100：<b id="cG4">0</b> / 425</div>
    </div>

    <div class="box" id="box"></div>

    <div class="muted">热点窗口：S1[1–20]、S3[190–230]、S4[360–420]、S5[460–500]</div>

    <h3 style="margin-top:14px">段配额</h3>
    <table>
      <thead><tr><th>段别</th><th>区间</th><th>次数</th><th>一等奖</th><th>二等奖</th><th>三等奖</th><th>四等奖(兜底)</th></tr></thead>
      <tbody id="segTable"></tbody>
    </table>
  </div>

  <div class="card">
    <canvas id="chart"></canvas>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
// ===== 你的 Apps Script 地址（仅上报 ID号、奖项、抽奖时间） =====
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzW68GNeAgwX_5Bw0kRqcG2EBX_uT6G-FPvmLEQwF9ufCuQSVWUAs4R3x6E9cZ-26GF/exec";

// ===== 全局参数 =====
const TOTAL_DRAWS = 500;
const CONFIG = {
  segments: [
    {name:"S1", start:1, end:50},
    {name:"S2", start:51, end:150},
    {name:"S3", start:151, end:300},
    {name:"S4", start:301, end:450},
    {name:"S5", start:451, end:500},
  ],
  quotas: { // 一二三等按分段配额；四等自动补足
    G1:[1,0,1,1,1],   // RM1000
    G2:[4,5,6,6,2],   // RM300
    G3:[10,10,12,12,4]// RM200
  },
  hotWindows: { // 用于G1热点窗口（开场/中场/后段/收官）
    0:[1,20],  2:[190,230], 3:[360,420], 4:[460,500]
  },
  values: {G1:1000, G2:300, G3:200, G4:100},
  labels: {G1:"RM1000 一等奖", G2:"RM300 二等奖", G3:"RM200 三等奖", G4:"RM100 四等奖"}
};

// ===== 工具函数 =====
function seededRandom(seed){
  return function() {
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function sampleWithoutReplacement(arr, k, rand=Math.random){
  const a = arr.slice(), res = [];
  for(let i=0;i<k && a.length>0;i++){
    const j = Math.floor(rand()*a.length);
    res.push(a[j]); a.splice(j,1);
  }
  return res;
}
function buildSchedule(seed){
  const rand = seededRandom(seed);
  const assignments = {}, occupied = new Set();
  const cfg = CONFIG;
  // G1 with hot windows
  cfg.segments.forEach((seg, idx)=>{
    const q = cfg.quotas.G1[idx]||0; if(q<=0) return;
    let start=seg.start, end=seg.end, candidates=[];
    if(cfg.hotWindows[idx]){
      let [hs,he] = cfg.hotWindows[idx];
      hs=Math.max(hs,start); he=Math.min(he,end);
      for(let d=hs; d<=he; d++) candidates.push(d);
      if(candidates.length<q){ // fallback to whole segment
        candidates=[]; for(let d=start; d<=end; d++) candidates.push(d);
      }
    }else{ for(let d=start; d<=end; d++) candidates.push(d); }
    const picks = sampleWithoutReplacement(candidates, q, rand);
    for(const d of picks){ assignments[d]="G1"; occupied.add(d); }
  });
  // G2/G3
  for(const prize of ["G2","G3"]){
    cfg.segments.forEach((seg, idx)=>{
      const q = cfg.quotas[prize][idx]||0; if(q<=0) return;
      const candidates = [];
      for(let d=seg.start; d<=seg.end; d++){ if(!occupied.has(d)) candidates.push(d); }
      const picks = sampleWithoutReplacement(candidates, q, rand);
      // 兜底补足
      let i=seg.start; while(picks.length<q && i<=seg.end){
        if(!occupied.has(i) && !picks.includes(i)) picks.push(i); i++;
      }
      for(const d of picks){ assignments[d]=prize; occupied.add(d); }
    });
  }
  // fill G4
  for(const seg of cfg.segments){ for(let d=seg.start; d<=seg.end; d++){ if(!assignments[d]) assignments[d]="G4"; } }
  return assignments;
}

// ===== 状态 =====
let state = { seed: Math.floor(Math.random()*1e9), schedule:{}, draw:0, counts:{G1:0,G2:0,G3:0,G4:0}, log:[], records:[] };

// ===== 视图引用 =====
const el = {
  progress: document.getElementById("progress"),
  result: document.getElementById("result"),
  cG1: document.getElementById("cG1"),
  cG2: document.getElementById("cG2"),
  cG3: document.getElementById("cG3"),
  cG4: document.getElementById("cG4"),
  segTable: document.getElementById("segTable"),
  log: document.getElementById("log"),
  chart: document.getElementById("chart"),
  box: document.getElementById("box"),
  logoBox: document.getElementById("logoBox"),
  userID: document.getElementById("userID"),
  chances: document.getElementById("chances")
};

// ===== 初始化/重置 =====
function reset(newSeed){
  state.seed = newSeed ?? Math.floor(Math.random()*1e9);
  state.schedule = buildSchedule(state.seed);
  state.draw = 0; state.counts = {G1:0,G2:0,G3:0,G4:0}; state.log = []; state.records = [];
  initChart(); render(); buildSegTable();
}
function buildSegTable(){
  const g4 = [];
  CONFIG.segments.forEach((seg, idx)=>{
    const len=seg.end - seg.start + 1;
    const g1=CONFIG.quotas.G1[idx]||0, g2=CONFIG.quotas.G2[idx]||0, g3=CONFIG.quotas.G3[idx]||0;
    g4[idx]=len-(g1+g2+g3);
  });
  el.segTable.innerHTML = CONFIG.segments.map((seg,idx)=>{
    const len=seg.end - seg.start + 1;
    return `<tr><td>${seg.name}</td><td>${seg.start}–${seg.end}</td><td>${len}</td>
      <td>${CONFIG.quotas.G1[idx]||0}</td><td>${CONFIG.quotas.G2[idx]||0}</td><td>${CONFIG.quotas.G3[idx]||0}</td><td>${g4[idx]}</td></tr>`;
  }).join("");
}

// ===== 抽奖引擎 =====
function doDraw(){
  if(state.draw>=TOTAL_DRAWS) return;
  const userID = el.userID.value.trim();
  if(!userID){ alert("请输入ID号"); return; }

  state.draw++;
  const code = state.schedule[state.draw];
  state.counts[code]++;
  const value = CONFIG.values[code];
  const label = CONFIG.labels[code];
  const now = new Date();
  const time = new Date(now.getTime() + 8*60*60*1000).toISOString().replace('T',' ').split('.')[0] + " GMT+8";

  state.log.unshift(`第 ${String(state.draw).padStart(3,"0")} 次 → ${label}`);
  if(state.log.length>400) state.log.pop();
  state.records.push({ userID, prize:label, time });

  // Google 记录（仅ID/奖项/时间）
  try {
    fetch(GOOGLE_SCRIPT_URL, {
      method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userID, prize:label, time })
    });
  } catch(e){ console.warn("Google记录失败（本地/跨域环境常见）：", e); }

  // 视觉反馈：Logo 摇动
  el.logoBox.classList.remove("shake"); void el.logoBox.offsetWidth; el.logoBox.classList.add("shake");
  render(); plotPoint(state.draw, value);
}
function simulate(n){
  const count = parseInt(n,10)||0;
  for(let i=0;i<count;i++){ if(state.draw>=TOTAL_DRAWS) break; doDraw(); }
}

// ===== 导出记录 =====
function exportCSV(){
  let csv = "\uFEFFID号,奖项,抽奖时间(GMT+8)\n";
  state.records.forEach(r=>{ csv += `${r.userID},${r.prize},${r.time}\n`; });
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "抽奖记录.csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// ===== 渲染 =====
function render(){
  el.progress.textContent = `第 ${state.draw} / ${TOTAL_DRAWS} 次`;
  el.result.textContent = state.log[0] ? state.log[0].split("→")[1].trim() : "—";
  el.cG1.textContent = state.counts.G1;
  el.cG2.textContent = state.counts.G2;
  el.cG3.textContent = state.counts.G3;
  el.cG4.textContent = state.counts.G4;
  el.log.innerHTML = state.log.map(l=>`<div>${l}</div>`).join("");
}

// ===== 简单散点图 =====
let ctx, chartW, chartH;
function initChart(){
  const canvas = el.chart;
  const dpr = window.devicePixelRatio || 1;
  chartW = canvas.clientWidth * dpr;
  chartH = canvas.clientHeight * dpr;
  canvas.width = chartW; canvas.height = chartH;
  ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,chartW,chartH);
  ctx.strokeStyle = "#2a3344"; ctx.lineWidth = 1;
  [100,200,300,1000].forEach(v=>{
    const y = mapY(v);
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(chartW,y); ctx.stroke();
    ctx.fillStyle="#64748b"; ctx.font = `${12*(window.devicePixelRatio||1)}px sans-serif`;
    ctx.fillText("RM"+v, 6, y-4);
  });
}
function mapX(n){ return (n/TOTAL_DRAWS)* (chartW-20) + 10; }
function mapY(v){ const vmin=100, vmax=1000; const t=(v-vmin)/(vmax-vmin); return chartH - (t*(chartH-20)+10); }
function plotPoint(n, value){
  if(!ctx) return;
  ctx.fillStyle = "#60a5fa";
  const x = mapX(n), y = mapY(value);
  ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
}

// ===== 事件绑定 & 图片替换 =====
document.getElementById("btnStart").onclick = ()=>{
  const n = parseInt(el.chances.value || "1", 10);
  for(let i=0;i<n;i++){ setTimeout(()=>doDraw(), i*300); }
};
document.getElementById("btnExport").onclick = exportCSV;
document.getElementById("btnDraw").onclick = ()=>doDraw();
document.getElementById("btnSim100").onclick = ()=>simulate(100);
document.getElementById("btnFinish").onclick = ()=>simulate(1000);
document.getElementById("btnReset").onclick = ()=>reset();

document.getElementById("boxImageInput").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => el.box.style.backgroundImage = `url(${evt.target.result})`;
  reader.readAsDataURL(file);
});
document.getElementById("bgImageInput").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => { document.body.style.background = `#000 url(${evt.target.result}) center/cover no-repeat fixed`; };
  reader.readAsDataURL(file);
});

// 初始
window.addEventListener("resize", ()=>{ initChart(); render(); });
reset();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>818å¯èˆªç››å…¸ä»»åŠ¡ç›²ç›’ Â· 818 Grand Launch Â· Task Mystery Box</title>
  <meta name="description" content="818å¯èˆªç››å…¸ä»»åŠ¡ç›²ç›’ Â· 500æ¬¡åˆ†æ®µæ‰è½ Â· ä¸ŠæŠ¥ID/å¥–é¡¹/æŠ½å¥–æ—¶é—´(GMT+8)" />
  <style>
    :root { --overlay: rgba(170, 24, 24, .58); --overlay2: rgba(255, 92, 0, .38); }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue","Noto Sans",Arial;
      color:#fff;
      /* ä½ çš„èƒŒæ™¯å›¾ï¼›å¦‚æ–‡ä»¶åä¸åŒå¯æ›¿æ¢ */
      background: url('131645db-2ca0-42dd-881c-49c5da42181e.png') center/cover no-repeat fixed;
      position: relative; min-height: 100vh;
    }
    /* æŸ“è‰² + æé«˜å¯è¯»æ€§ */
    body::before{
      content:""; position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 50% 30%, var(--overlay2), rgba(0,0,0,0) 70%),
        linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.55) 30%, rgba(0,0,0,.75));
      pointer-events:none; z-index:-1;
    }
    header{ padding: 28px 16px 12px; text-align:center; text-shadow: 0 2px 12px rgba(0,0,0,.45); }
    h1{ margin:0; font-size: clamp(24px, 4vw, 40px); letter-spacing:.5px; font-weight:800; }
    .subtitle{ margin-top:6px; color:#ffd7a8; font-size: clamp(12px, 2.2vw, 16px); }
    .container{ max-width: 960px; margin: 0 auto; padding: 16px; }
    .panel{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: 14px; padding: 18px;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .form-box input[type="text"], .form-box input[type="number"], .form-box input[type="email"]{
      width: 260px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.35); color:#fff; margin:6px;
    }
    .form-box label{font-size:12px;color:#ffd7a8}
    .form-box button{
      padding: 10px 20px; font-size: 18px;
      background: linear-gradient(135deg,#ff7a00,#ffb703); color:#1a1a1a; border:none; border-radius:10px; cursor:pointer; margin-top:10px;
      box-shadow: 0 6px 18px rgba(255,122,0,.35);
    }
    .box{
      width: 240px; height: 240px; margin:24px auto 0; border-radius:18px;
      /* ä½ çš„ç›²ç›’å›¾ï¼›å¦‚æ–‡ä»¶åä¸åŒå¯æ›¿æ¢ */
      background: url('mang he.png') center/cover no-repeat;
      box-shadow: 0 12px 36px rgba(0,0,0,.45); animation: shake 0s;
    }
    @keyframes shake {
      0% { transform: translate(0, 0) rotate(0deg); }
      10% { transform: translate(-8px, 6px) rotate(-5deg); }
      20% { transform: translate(8px, -6px) rotate(5deg); }
      30% { transform: translate(-10px, 8px) rotate(-6deg); }
      40% { transform: translate(10px, -8px) rotate(6deg); }
      50% { transform: translate(-6px, 6px) rotate(-4deg); }
      60% { transform: translate(6px, -6px) rotate(4deg); }
      70% { transform: translate(-4px, 4px) rotate(-3deg); }
      80% { transform: translate(4px, -4px) rotate(3deg); }
      90% { transform: translate(-2px, 2px) rotate(-2deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }
    #result{
      max-height:320px; overflow:auto; margin-top:12px;
      display:flex; flex-direction: column; gap:6px;
    }
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .file-group{display:inline-flex;align-items:center;gap:6px}
    .clear{font-size:12px;padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.2);color:#fff;cursor:pointer}
    .muted{opacity:.7;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>818å¯èˆªç››å…¸ä»»åŠ¡ç›²ç›’</h1>
    <div class="subtitle">818 Grand Launch Â· Task Mystery Box</div>
  </header>

  <div class="container">
    <div class="panel">
      <div class="form-box" style="text-align:center">
        <div class="row">
          <input type="text" id="userID" placeholder="è¯·è¾“å…¥æ‚¨çš„IDå· (ZMYXXXXXXXX)" />
          <input type="email" id="email" placeholder="ï¼ˆå¯é€‰ï¼‰è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ / Optional email" />
          <input type="number" id="chances" placeholder="è¯·è¾“å…¥æŠ½å¥–æ¬¡æ•° / Draws" min="1" value="1" />
        </div>
        <div class="row" style="margin-top:8px">
          <div class="file-group">
            <label>ä¸Šä¼ ç›²ç›’å›¾ç‰‡ï¼š</label>
            <input type="file" id="boxImageInput" accept="image/*"><button class="clear" onclick="clearBoxImage()">âŒ</button>
          </div>
          <div class="file-group">
            <label>ä¸Šä¼ èƒŒæ™¯å›¾ï¼š</label>
            <input type="file" id="bgImageInput" accept="image/*"><button class="clear" onclick="clearBackgroundImage()">âŒ</button>
          </div>
        </div>

        <button onclick="startDraws()">å¼€å§‹æŠ½å¥– / Start</button>
        <div class="box" id="box"></div>
        <div id="result"></div>
        <button onclick="exportToExcel()">å¯¼å‡ºæŠ½å¥–æ•°æ® CSV</button>
      </div>
    </div>
  </div>

  <input type="password" id="adminPass" placeholder="è¯·è¾“å…¥å¯†ç ä»¥é‡è®¾å¥–æ± " style="position: fixed; bottom: 10px; right: 10px; width: 180px; padding: 5px; font-size: 12px; opacity: 0.1; z-index: 999;">

<script>
  // ===== ä½ çš„ Apps Script æ¥å£ï¼ˆåªä¸ŠæŠ¥ä¸‰åˆ—ï¼šIDå·/å¥–é¡¹/æŠ½å¥–æ—¶é—´GMT+8ï¼‰ =====
  const googleScriptURL = "https://script.google.com/macros/s/AKfycbzW68GNeAgwX_5Bw0kRqcG2EBX_uT6G-FPvmLEQwF9ufCuQSVWUAs4R3x6E9cZ-26GF/exec";

  // ===== 500æ¬¡ Â· åˆ†æ®µæ‰è½ â€”â€” é…é¢ + RM1000 ç¡¬çª—å£ =====
  const CONFIG = {
    segments: [
      {name:"S1", start:1,   end:50},
      {name:"S2", start:51,  end:150},
      {name:"S3", start:151, end:300},
      {name:"S4", start:301, end:450},
      {name:"S5", start:451, end:500},
    ],
    // é…é¢ï¼šæŒ‰ä½ çš„è¡¨
    quotas: {
      G1:[1,0,1,1,1],          // RM1000
      G2:[2,4,6,5,6],          // RM300
      G3:[8,10,10,10,10]       // RM200
    },
    // RM100 è‡ªåŠ¨è¡¥è¶³ï¼ˆæ®µé•¿ âˆ’ å·²åˆ†é…ï¼‰
    labels: {
      G1:"RM1000 ä¸€ç­‰å¥– / First Prize",
      G2:"RM300 äºŒç­‰å¥– / Second Prize",
      G3:"RM200 ä¸‰ç­‰å¥– / Third Prize",
      G4:"RM100 å››ç­‰å¥– / Fourth Prize"
    },
    // RM1000 ç¡¬çª—å£ï¼ˆæ¯ä¸ªçª—å£æ°å¥½ 1 æ¬¡ï¼‰
    hardG1Windows: {
      0:[20,50],    // S1ï¼š20â€“50
      2:[190,230],  // S3ï¼š190â€“230
      3:[360,420],  // S4ï¼š360â€“420
      4:[460,500]   // S5ï¼š460â€“500
    }
  };

  // ===== å·¥å…·å‡½æ•° =====
  function seededRandom(seed){
    return function() {
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }
  function sampleWithoutReplacement(arr, k, rand=Math.random){
    const a = arr.slice(), res = [];
    for(let i=0;i<k && a.length>0;i++){
      const j = Math.floor(rand()*a.length);
      res.push(a[j]); a.splice(j,1);
    }
    return res;
  }

  // ===== é¢„é‡‡æ ·è®¡åˆ’ï¼ˆä¸¥æ ¼çª—å£ + æ®µå†…ä¸æ”¾å›ï¼‰ =====
  function buildSchedule(seed){
    const rand = seededRandom(seed);
    const assignments = {}, occupied = new Set();

    // ä¸€ç­‰å¥–ï¼šä¸¥æ ¼åœ¨ç¡¬çª—å£å†…é‡‡æ ·
    CONFIG.segments.forEach((seg, idx)=>{
      const q = CONFIG.quotas.G1[idx]||0; if(q<=0) return;
      const window = CONFIG.hardG1Windows[idx];
      if(!window){ return; }
      const [hs0, he0] = window;
      const hs = Math.max(hs0, seg.start), he = Math.min(he0, seg.end);
      const candidates = []; for(let d=hs; d<=he; d++) candidates.push(d);
      const picks = sampleWithoutReplacement(candidates, q, rand);
      for(const d of picks){ assignments[d]="G1"; occupied.add(d); }
    });

    // äºŒ/ä¸‰ç­‰å¥–ï¼šåœ¨å‰©ä½™ç©ºä½å†…å„æ®µéšæœºï¼›è‹¥ä¸è¶³åˆ™æ®µå†…é¡ºå»¶è¡¥é½
    for(const prize of ["G2","G3"]){
      CONFIG.segments.forEach((seg, idx)=>{
        const q = CONFIG.quotas[prize][idx]||0; if(q<=0) return;
        const candidates = [];
        for(let d=seg.start; d<=seg.end; d++){ if(!occupied.has(d)) candidates.push(d); }
        let picks = sampleWithoutReplacement(candidates, q, rand);
        if(picks.length < q){
          let i=seg.start; while(picks.length<q && i<=seg.end){
            if(!occupied.has(i) && !picks.includes(i)) picks.push(i);
            i++;
          }
        }
        for(const d of picks){ assignments[d]=prize; occupied.add(d); }
      });
    }

    // å…¶ä½™å…¨éƒ¨å¡«å……ä¸ºå››ç­‰å¥–ï¼ˆRM100ï¼‰
    for(const seg of CONFIG.segments){
      for(let d=seg.start; d<=seg.end; d++){ if(!assignments[d]) assignments[d]="G4"; }
    }
    return assignments;
  }

  // ===== çŠ¶æ€ä¸å…ƒç´  =====
  const box = document.getElementById("box");
  const result = document.getElementById("result");
  let schedule = {};
  let globalDrawCount = 0;
  let isShaking = false;
  const drawRecords = [];

  function initPrizePlan() {
    schedule = buildSchedule(Math.floor(Math.random()*1e9));
    globalDrawCount = 0;
    result.innerHTML = "";
  }
  initPrizePlan();

  function resetPrizePool() { initPrizePlan(); alert("å¥–æ± å·²é‡ç½®ï¼Œå·²é‡æ–°ç”Ÿæˆ500æ¬¡æ‰è½è®¡åˆ’ã€‚"); }

  function startDraws() {
    const userID = document.getElementById("userID").value.trim();
    const chancesVal = document.getElementById("chances").value.trim();
    const chances = parseInt(chancesVal);
    if (!userID || isNaN(chances) || chances < 1) {
      alert("è¯·è¾“å…¥IDå·ï¼Œå¹¶ç¡®ä¿æŠ½å¥–æ¬¡æ•° â‰¥ 1ï¼ / Please input ID and a valid number of draws (â‰¥1).");
      return;
    }
    runDraw(chances, userID);
  }

  function runDraw(remaining, userID) {
    if (isShaking || remaining <= 0) return;
    if (globalDrawCount >= 500) { alert("å·²åˆ°è¾¾500æ¬¡ä¸Šé™ / Reached 500-draw limit"); return; }

    isShaking = true;
    box.style.animation = "shake 1.2s ease-in-out";

    setTimeout(() => {
      globalDrawCount++;
      const prizeCode = schedule[globalDrawCount];
      const prizeLabel = CONFIG.labels[prizeCode] || "RM100 å››ç­‰å¥– / Fourth Prize";

      box.style.animation = "none";

      const now = new Date();
      const gmt8Time = new Date(now.getTime() + 8 * 60 * 60 * 1000)
        .toISOString().replace('T', ' ').split('.')[0] + ' GMT+8';

      drawRecords.push({ userID, prize: prizeLabel, time: gmt8Time });

      // ä¸ŠæŠ¥åˆ° Google è¡¨æ ¼ï¼ˆä»…ä¸‰åˆ—ï¼‰
      fetch(googleScriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userID, prize: prizeLabel, time: gmt8Time })
      });

      // åŒè¯­ç»“æœ + æœ€æ–°ç½®é¡¶
      const line = `ğŸ‰ <b>${userID}</b> æŠ½ä¸­ / won: <b>${prizeLabel}</b> <span class="muted">(${gmt8Time})</span>`;
      const div = document.createElement('div');
      div.innerHTML = line;
      result.prepend(div);
      result.scrollTop = 0;

      isShaking = false;
      if (remaining > 1) setTimeout(() => runDraw(remaining - 1, userID), 300);
    }, 1200);
  }

  function exportToExcel() {
    let csv = 'IDå·,å¥–é¡¹,æŠ½å¥–æ—¶é—´ (GMT+8)\n';
    drawRecords.forEach(r => { csv += `${r.userID},${r.prize},${r.time}\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'æŠ½å¥–è®°å½•.csv';
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  // å›¾ç‰‡æ›¿æ¢
  document.getElementById("boxImageInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) { box.style.backgroundImage = `url(${evt.target.result})`; };
    reader.readAsDataURL(file);
  });
  document.getElementById("bgImageInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      document.body.style.background = `url(${evt.target.result}) center/cover no-repeat fixed`;
    };
    reader.readAsDataURL(file);
  });
  function clearBackgroundImage() {
    document.body.style.background = "url('131645db-2ca0-42dd-881c-49c5da42181e.png') center/cover no-repeat fixed";
  }
  function clearBoxImage() {
    box.style.backgroundImage = "url('mang he.png')";
  }

  // ç®¡ç†é‡ç½®
  document.getElementById("adminPass").addEventListener("change", function(e) {
    const pwd = e.target.value.trim();
    if (pwd === "888888") {
      resetPrizePool();
      e.target.value = "";
    } else {
      alert("å¯†ç é”™è¯¯ / Wrong password");
      e.target.value = "";
    }
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨æ°‘ä»£è¨€è®¡åˆ’ç›²ç›’æŠ½å¥–</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(to bottom right, #ff7f00, #000000);
      padding: 2rem;
      overflow-x: hidden;
    }
    h1 { color: #fff; }
    .form-box { margin-bottom: 1.5rem; }
    input {
      padding: 0.5rem;
      font-size: 16px;
      margin: 0.25rem;
      width: 250px;
    }
    .box-container {
      margin: 2rem auto;
      width: 220px;
      height: 220px;
      animation: shake 0s;
      background-image: url('mang he.png'); /* é»˜è®¤ä½¿ç”¨ä½ æä¾›çš„æ–°å›¾ */
      background-size: cover;
      background-position: center;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    @keyframes shake {
      0% { transform: translate(0, 0) rotate(0deg); }
      10% { transform: translate(-8px, 6px) rotate(-5deg); }
      20% { transform: translate(8px, -6px) rotate(5deg); }
      30% { transform: translate(-10px, 8px) rotate(-6deg); }
      40% { transform: translate(10px, -8px) rotate(6deg); }
      50% { transform: translate(-6px, 6px) rotate(-4deg); }
      60% { transform: translate(6px, -6px) rotate(4deg); }
      70% { transform: translate(-4px, 4px) rotate(-3deg); }
      80% { transform: translate(4px, -4px) rotate(3deg); }
      90% { transform: translate(-2px, 2px) rotate(-2deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      background: #ff6600;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 1rem;
    }
    #result {
      margin-top: 1.5rem;
      font-size: 20px;
      color: #fff;
      max-height: 300px;
      overflow-y: auto;
    }
    .note { color: #ffd7a8; font-size: 14px; margin-top: 8px; opacity: .9; }
  </style>
</head>
<body>
  <h1>å…¨æ°‘ä»£è¨€è®¡åˆ’ç›²ç›’æŠ½å¥–</h1>
  <div class="form-box">
    <input type="text" id="userID" placeholder="è¯·è¾“å…¥æ‚¨çš„IDå· (ZMYXXXXXXXX)" /><br>
    <input type="email" id="email" placeholder="ï¼ˆå¯é€‰ï¼‰è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" /><br>
    <input type="number" id="chances" placeholder="è¯·è¾“å…¥æŠ½å¥–æ¬¡æ•°" min="1" /><br>
    <label>ä¸Šä¼ ç›²ç›’å›¾ç‰‡ï¼š</label>
    <div style="display: inline-flex; align-items: center; gap: 6px;"><input type="file" id="boxImageInput" accept="image/*"><button onclick="clearBoxImage()" style="font-size: 12px; padding: 2px 6px;">âŒ</button></div><br>
    <label>ä¸Šä¼ èƒŒæ™¯å›¾ï¼š</label>
    <div style="display: inline-flex; align-items: center; gap: 6px;"><input type="file" id="bgImageInput" accept="image/*"><button onclick="clearBackgroundImage()" style="font-size: 12px; padding: 2px 6px;">âŒ</button></div><br>
    <button onclick="startDraws()">å¼€å§‹æŠ½å¥–</button>
    <div class="note">è¯´æ˜ï¼šå¥–å“å·²æŒ‰â€œ500ä»½åˆ†æ®µæ‰è½â€é€»è¾‘æ¤å…¥ï¼›ä¸ŠæŠ¥ä»…åŒ…å«ï¼šIDå·ã€å¥–é¡¹ã€æŠ½å¥–æ—¶é—´(GMT+8)ã€‚é»˜è®¤ç›²ç›’å›¾å·²æ›¿æ¢ä¸ºä½ æä¾›çš„æ–°å›¾ã€‚</div>
  </div>
  <div class="box-container" id="box"></div>
  <div id="result"></div> 
  <button onclick="exportToExcel()">å¯¼å‡ºæŠ½å¥–æ•°æ®</button>

  <input type="password" id="adminPass" placeholder="è¯·è¾“å…¥å¯†ç ä»¥é‡è®¾å¥–æ± " style="position: fixed; bottom: 10px; right: 10px; width: 180px; padding: 5px; font-size: 12px; opacity: 0.1; z-index: 999;">

  <script>
    // ========= ä»…ä¸ŠæŠ¥ä¸‰åˆ—åˆ°ä½ çš„ Apps Script =========
    const googleScriptURL = "https://script.google.com/macros/s/AKfycbzW68GNeAgwX_5Bw0kRqcG2EBX_uT6G-FPvmLEQwF9ufCuQSVWUAs4R3x6E9cZ-26GF/exec";

    // ========= 500æ¬¡ Â· åˆ†æ®µæ‰è½é…ç½® =========
    const CONFIG = {
      segments: [
        {name:"S1", start:1, end:50},
        {name:"S2", start:51, end:150},
        {name:"S3", start:151, end:300},
        {name:"S4", start:301, end:450},
        {name:"S5", start:451, end:500},
      ],
      quotas: { G1:[1,0,1,1,1], G2:[4,5,6,6,2], G3:[10,10,12,12,4] },
      values: { G1:1000, G2:300, G3:200, G4:100 },
      labels: { G1:"RM1000 ä¸€ç­‰å¥–", G2:"RM300 äºŒç­‰å¥–", G3:"RM200 ä¸‰ç­‰å¥–", G4:"RM100 å››ç­‰å¥–" },
      hotWindows: { 0:[1,20], 2:[190,230], 3:[360,420], 4:[460,500] } // ä¸€ç­‰å¥–çƒ­ç‚¹çª—å£
    };

    function seededRandom(seed){
      return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
    function sampleWithoutReplacement(arr, k, rand=Math.random){
      const a = arr.slice(), res = [];
      for(let i=0;i<k && a.length>0;i++){
        const j = Math.floor(rand()*a.length);
        res.push(a[j]); a.splice(j,1);
      }
      return res;
    }
    function buildSchedule(seed){
      const rand = seededRandom(seed);
      const assignments = {}, occupied = new Set();
      // G1 with hot windows
      CONFIG.segments.forEach((seg, idx)=>{
        const q = CONFIG.quotas.G1[idx]||0; if(q<=0) return;
        const s=seg.start, e=seg.end;
        let candidates = [];
        if(CONFIG.hotWindows[idx]){
          let [hs,he] = CONFIG.hotWindows[idx];
          hs = Math.max(hs, s); he = Math.min(he, e);
          for(let d=hs; d<=he; d++) candidates.push(d);
          if(candidates.length < q){ candidates = []; for(let d=s; d<=e; d++) candidates.push(d); }
        } else { for(let d=s; d<=e; d++) candidates.push(d); }
        const picks = sampleWithoutReplacement(candidates, q, rand);
        for(const d of picks){ assignments[d] = "G1"; occupied.add(d); }
      });
      // G2/G3
      for(const prize of ["G2","G3"]){
        CONFIG.segments.forEach((seg, idx)=>{
          const q = CONFIG.quotas[prize][idx]||0; if(q<=0) return;
          const candidates = [];
          for(let d=seg.start; d<=seg.end; d++){ if(!occupied.has(d)) candidates.push(d); }
          let picks = sampleWithoutReplacement(candidates, q, rand);
          if(picks.length < q){
            let i=seg.start; while(picks.length<q && i<=seg.end){
              if(!occupied.has(i) && !picks.includes(i)) picks.push(i); i++;
            }
          }
          for(const d of picks){ assignments[d] = prize; occupied.add(d); }
        });
      }
      // fill G4
      for(const seg of CONFIG.segments){
        for(let d=seg.start; d<=seg.end; d++){ if(!assignments[d]) assignments[d] = "G4"; }
      }
      return assignments;
    }

    const box = document.getElementById("box");
    const result = document.getElementById("result");
    let schedule = {};
    let globalDrawCount = 0;
    let isShaking = false;
    const drawRecords = [];  // ä»…ä¸‰åˆ—

    function initPrizePlan() {
      schedule = buildSchedule(Math.floor(Math.random()*1e9));
      globalDrawCount = 0;
      result.innerHTML = "";
      localStorage.removeItem('drawHistory');
    }
    initPrizePlan();

    function resetPrizePool() { initPrizePlan(); alert("å¥–æ± å·²é‡ç½®ï¼Œå·²é‡æ–°ç”Ÿæˆ500æ¬¡æ‰è½è®¡åˆ’ã€‚"); }

    window.addEventListener('load', () => {
      const saved = localStorage.getItem('drawHistory');
      if (saved) result.innerHTML = saved;
    });

    function startDraws() {
      const userID = document.getElementById("userID").value.trim();
      const chancesVal = document.getElementById("chances").value.trim();
      const chances = parseInt(chancesVal);
      if (!userID || isNaN(chances) || chances < 1) {
        alert("è¯·è¾“å…¥IDå·ï¼Œå¹¶ç¡®ä¿æŠ½å¥–æ¬¡æ•° â‰¥ 1ï¼");
        return;
      }
      runDraw(chances, userID);
    }

    function runDraw(remaining, userID) {
      if (isShaking || remaining <= 0) return;
      if (globalDrawCount >= 500) { alert("å·²åˆ°è¾¾500æ¬¡ä¸Šé™"); return; }

      isShaking = true;
      result.innerHTML += `<div style='opacity:0.6'>ğŸ² ç¬¬ ${globalDrawCount + 1} æ¬¡æŠ½å¥–ä¸­...</div>`;
      box.style.animation = "shake 1.2s ease-in-out";

      setTimeout(() => {
        globalDrawCount++;
        const prizeCode = schedule[globalDrawCount];
        const prizeLabel = CONFIG.labels[prizeCode] || "RM100 å››ç­‰å¥–";

        box.style.animation = "none";
        box.textContent = "";

        const now = new Date();
        const gmt8Time = new Date(now.getTime() + 8 * 60 * 60 * 1000)
          .toISOString().replace('T', ' ').split('.')[0] + ' GMT+8';

        drawRecords.push({ userID, prize: prizeLabel, time: gmt8Time });

        // åªä¸ŠæŠ¥ä¸‰åˆ—
        fetch(googleScriptURL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userID, prize: prizeLabel, time: gmt8Time })
        });

        result.innerHTML += `<div>ğŸ‰ ${userID} æŠ½ä¸­äº†ï¼š<strong>${prizeLabel}</strong>ï¼ˆ${gmt8Time}ï¼‰</div>`;
        localStorage.setItem('drawHistory', result.innerHTML);
        isShaking = false;
        if (remaining > 1) setTimeout(() => runDraw(remaining - 1, userID), 300);
      }, 1200);
    }

    function exportToExcel() {
      let csv = 'IDå·,å¥–é¡¹,æŠ½å¥–æ—¶é—´ (GMT+8)\n';
      drawRecords.forEach(r => { csv += `${r.userID},${r.prize},${r.time}\n`; });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'æŠ½å¥–è®°å½•.csv';
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById("boxImageInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) { box.style.backgroundImage = `url(${evt.target.result})`; };
      reader.readAsDataURL(file);
    });

    document.getElementById("bgImageInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        document.body.style.backgroundImage = `url(${evt.target.result})`;
        document.body.style.backgroundSize = "cover";
        document.body.style.backgroundPosition = "center";
      };
      reader.readAsDataURL(file);
    });

    function clearBackgroundImage() { document.body.style.backgroundImage = ''; }
    function clearBoxImage() { box.style.backgroundImage = "url('mang he.png')"; } // æ¢å¤é»˜è®¤æ–°å›¾

    document.getElementById("adminPass").addEventListener("change", function(e) {
      const pwd = e.target.value.trim();
      if (pwd === "888888") {
        resetPrizePool();
        e.target.value = "";
      } else {
        alert("å¯†ç é”™è¯¯");
        e.target.value = "";
      }
    });
  </script>
</body>
</html>